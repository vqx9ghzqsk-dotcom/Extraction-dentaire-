<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âtude pr√©valence indications extraction dentaire - H√¥pital G√©n√©ral de Makala</title>
    <style>
        /* --- STYLE GLOBAL (Conserv√© et Adapt√©) --- */
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f4f8; margin: 0; padding: 15px; }
        .container { max-width: 1200px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.15); min-height: 900px;}
        
        /* Navigation (Bleu clinique pour le dentaire au lieu du rose cancer du sein) */
        .header-tabs { display: flex; background: #fff; border-bottom: 3px solid #0277bd; padding: 12px; align-items: center; gap: 8px; position: sticky; top: 0; z-index: 100; }
        .tab { padding: 10px 15px; font-weight: bold; font-size: 12px; text-decoration: none; border-radius: 4px; border: 1px solid #ddd; color: #555; background: #f8f9fa; cursor: pointer; transition: 0.2s; }
        .tab.active { background: #0277bd; color: white; border-color: #0277bd; }
        
        .sim-badge { background: #ff9800; color: white; padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 10px; }
        .admin-only { display: none !important; }
        .admin-visible { display: inline-block !important; }
        
        .btn-auth { margin-left: auto; background: #333; color: white; padding: 10px 15px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-excel { background: #2e7d32; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-left: 10px;}
        .btn-delete-selected { background: #c62828; color: white; padding: 8px 15px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-bottom: 10px; display: none; }
        .btn-view-single { background: none; border: 1px solid #0288d1; color: #0288d1; cursor: pointer; border-radius: 4px; padding: 2px 5px; font-size: 10px; }
        .btn-view-single:hover { background: #0288d1; color: white; }

        /* Contenu */
        .form-content { padding: 30px; display: none; }
        .form-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Sections */
        .section-title { background: #e1f5fe; color: #0277bd; padding: 15px; font-weight: bold; border-left: 8px solid #0277bd; margin: 30px 0 15px 0; text-transform: uppercase; font-size: 14px; display: flex; align-items: center; justify-content: space-between; }
        .sub-title { font-weight: bold; color: #0277bd; margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 15px; }
        .field { display: flex; flex-direction: column; }
        label { font-size: 13px; font-weight: 700; margin-bottom: 6px; color: #222; }
        select, input[type="text"], input[type="number"], input[type="date"], textarea { padding: 10px; border: 1px solid #bbb; border-radius: 6px; font-size: 14px; background: #fff; width: 100%; box-sizing: border-box; }

        /* Tables & Check */
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 12px; }
        th { background: #f8f9fa; padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; }
        td { border: 1px solid #eee; padding: 10px; text-align: center; vertical-align: middle; }

        .btn-save { width: 100%; background: #0277bd; color: white; padding: 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 40px; text-transform: uppercase; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-save:hover { background: #01579b; transform: translateY(-2px); }
        
        /* Stats */
        .stat-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-title { font-weight: bold; color: #555; margin-bottom: 15px; font-size: 14px; border-bottom: 2px solid #0277bd; display: inline-block; }
        
        .bar-container { display: flex; align-items: center; margin-bottom: 12px; font-size: 12px; }
        .bar-label { width: 220px; font-weight: 600; color: #444; }
        .bar-track { flex-grow: 1; background: #f0f0f0; height: 20px; border-radius: 10px; margin: 0 15px; overflow: hidden; }
        .bar-fill { height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold; transition: width 1s; }
        .bar-value { width: 40px; text-align: right; font-weight: bold; color: #0277bd; }

        .counter-badge { background: #0277bd; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; vertical-align: middle; margin-left: 5px;}

        /* Modal & Toast (Identique) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 80%; max-width: 600px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 13px; }
        
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; font-size: 17px; }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

<div class="container">
    <div class="header-tabs">
        <button class="tab active" onclick="switchTab(1)">1. SAISIE CLINIQUE <span id="count-badge" class="counter-badge">0</span></button>
        <button class="tab admin-only" id="tab-2" onclick="switchTab(2)">2. MATRICE DE DONN√âES</button>
        <button class="tab admin-only" id="tab-3" onclick="switchTab(3)">3. ANALYSE STATISTIQUE</button>
        
        <div class="sim-badge">HGR MAKALA - DENTISTERIE</div>
        <button type="button" class="btn-auth" id="btn-auth" onclick="window.requestAdmin()">üîí ADMIN / DATA MANAGER</button>
        <button type="button" class="btn-excel admin-only" id="btn-export" onclick="window.exportToCSV()">üìä EXPORT CSV</button>
    </div>

    <div id="content-1" class="form-content active">
        <h2 style="color:#0277bd; font-size: 18px; text-align:center; margin-bottom: 25px;">√âtude r√©trospective sur la pr√©valence des indications de l‚Äôextraction dentaire √† l‚ÄôH√¥pital G√©n√©ral de Makala</h2>
        
        <form id="dentalForm">
            <div class="section-title">I. IDENTIFICATION DU DOSSIER</div>
            <div class="row">
                <div class="field">
                    <label>Num√©ro du dossier (ID)</label>
                    <input type="text" id="id-dossier" placeholder="Ex: EXT-2024-001">
                </div>
                <div class="field">
                    <label>Date de consultation</label>
                    <input type="date" id="date-consultation">
                </div>
            </div>

            <div class="section-title">II. DONN√âES SOCIOD√âMOGRAPHIQUES</div>
            <div class="row">
                <div class="field">
                    <label>√Çge (ans)</label>
                    <input type="number" id="age" min="1" max="100" placeholder="Ex: 35">
                </div>
                <div class="field">
                    <label>Sexe</label>
                    <select id="sexe">
                        <option value="M">1 = Masculin</option>
                        <option value="F">2 = F√©minin</option>
                    </select>
                </div>
                <div class="field">
                    <label>Profession</label>
                    <input type="text" id="profession" placeholder="Ex: Enseignant, Sans emploi...">
                </div>
            </div>
            <div class="row">
                <div class="field">
                    <label>Lieu de r√©sidence</label>
                    <input type="text" id="residence" placeholder="Commune de...">
                </div>
            </div>

            <div class="section-title">III. DONN√âES CLINIQUES</div>
            <div class="row">
                <div class="field">
                    <label>Motif de consultation</label>
                    <input type="text" id="motif" placeholder="Douleur, gonflement, esth√©tique...">
                </div>
                <div class="field">
                    <label>Dent concern√©e (Num√©ro ISO)</label>
                    <select id="dent">
                        <option value="" disabled selected>Choisir la dent...</option>
                        <optgroup label="Maxillaire Droit (Q1)">
                            <option value="18">18 (Sagesse)</option><option value="17">17</option><option value="16">16</option><option value="15">15</option><option value="14">14</option><option value="13">13</option><option value="12">12</option><option value="11">11</option>
                        </optgroup>
                        <optgroup label="Maxillaire Gauche (Q2)">
                            <option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option>
                        </optgroup>
                        <optgroup label="Mandibulaire Gauche (Q3)">
                            <option value="31">31</option><option value="32">32</option><option value="33">33</option><option value="34">34</option><option value="35">35</option><option value="36">36</option><option value="37">37</option><option value="38">38</option>
                        </optgroup>
                        <optgroup label="Mandibulaire Droit (Q4)">
                            <option value="41">41</option><option value="42">42</option><option value="43">43</option><option value="44">44</option><option value="45">45</option><option value="46">46</option><option value="47">47</option><option value="48">48</option>
                        </optgroup>
                    </select>
                </div>
                <div class="field">
                    <label>Arcade</label>
                    <select id="arcade">
                        <option value="Maxillaire">1 = Maxillaire (Haut)</option>
                        <option value="Mandibulaire">2 = Mandibulaire (Bas)</option>
                    </select>
                </div>
            </div>

            <div class="section-title">IV. INDICATION DE L‚ÄôEXTRACTION (INDIC)</div>
            <div class="row" style="background:#e3f2fd; padding:15px; border-radius:8px;">
                <div class="field">
                    <label style="color:#01579b; font-size:15px;">Diagnostic Principal :</label>
                    <select id="indication" style="font-weight:bold; color:#333;">
                        <option value="" disabled selected>S√©lectionner la cause...</option>
                        <option value="Carie avanc√©e">1 = Carie avanc√©e (D√©labrement)</option>
                        <option value="Complication pulpo-p√©riapicale">2 = Complication pulpo-p√©riapicale</option>
                        <option value="Maladie parodontale">3 = Maladie parodontale (Mobilit√©)</option>
                        <option value="Dent incluse/enclav√©e">4 = Dent incluse/enclav√©e</option>
                        <option value="Traumatisme dentaire">5 = Traumatisme dentaire</option>
                        <option value="Indication orthodontique">6 = Indication orthodontique</option>
                        <option value="Autres">7 = Autres</option>
                    </select>
                </div>
            </div>

            <div class="section-title">V. EXAMENS & TYPE D'ACTE</div>
            <div class="row">
                <div class="field">
                    <label>Radiographie Prise ?</label>
                    <select id="radio">
                        <option value="Non">0 = Non</option>
                        <option value="Oui">1 = Oui</option>
                    </select>
                </div>
                <div class="field">
                    <label>Type d'Extraction</label>
                    <select id="type-ext">
                        <option value="Simple">1 = Simple</option>
                        <option value="Chirurgicale">2 = Chirurgicale (Alv√©olectomie/S√©paration)</option>
                    </select>
                </div>
            </div>

            <div class="section-title">VII. COMPLICATIONS POST-OP</div>
            <div class="row">
                <div class="field">
                    <label>Complication imm√©diate/secondaire</label>
                    <select id="complication">
                        <option value="Aucune">0 = Aucune</option>
                        <option value="H√©morragie">1 = H√©morragie</option>
                        <option value="Infection">2 = Infection</option>
                        <option value="Alv√©olite">3 = Alv√©olite</option>
                        <option value="Autres">4 = Autres</option>
                    </select>
                </div>
                <div class="field">
                    <label>Nom de l'enqu√™teur</label>
                    <input type="text" id="enqueteur" value="Dr Stagiaire">
                </div>
            </div>

            <button type="button" id="save-btn" class="btn-save" onclick="window.saveRecord()">üíæ ENREGISTRER LA FICHE</button>
        </form>
    </div>

    <div id="content-2" class="form-content">
        <div class="section-title">MATRICE DE D√âPOUILLEMENT (N = <span id="n-total">0</span>)</div>
        <button id="btn-delete-multi" class="btn-delete-selected" onclick="window.deleteSelected()">üóëÔ∏è Supprimer la s√©lection</button>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all" onclick="window.toggleSelectAll(this)"></th>
                        <th>ID</th>
                        <th>Age/Sexe</th>
                        <th>Dent</th>
                        <th>Indication (Cause)</th>
                        <th>Type Ext.</th>
                        <th>Complication</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="database-body"></tbody>
            </table>
        </div>
    </div>

    <div id="content-3" class="form-content">
        <div class="section-title">1. PR√âVALENCE DES INDICATIONS (Motif principal)</div>
        <div class="stat-card">
            <div class="stat-title">Distribution des causes d'extraction (n=<span id="stat-n"></span>)</div>
            <div id="graph-indications"></div>
            [span_2](start_span)<p style="font-size:12px; color:#666;">Ce graphique montre la fr√©quence des pathologies menant √† l'extraction[span_2](end_span).</p>
        </div>

        <div class="row">
            <div class="stat-card">
                <div class="stat-title">2. [span_3](start_span)Type d'Extraction[span_3](end_span)</div>
                <div id="graph-type"></div>
            </div>
            <div class="stat-card">
                <div class="stat-title">3. [span_4](start_span)Taux de Complications[span_4](end_span)</div>
                <div id="graph-comps"></div>
            </div>
        </div>

        <div class="section-title">4. ANALYSE CROIS√âE : AGE vs INDICATION</div>
        <table style="width:100%; border: 1px solid #eee; background: white;">
            <thead style="background: #0277bd; color: white;">
                <tr>
                    [span_5](start_span)<th style="text-align:left; padding:15px;">GROUPE D'√ÇGE[span_5](end_span)</th>
                    <th>Indication Dominante</th>
                    <th>Fr√©quence Dominante</th>
                </tr>
            </thead>
            <tbody id="cross-body"></tbody>
        </table>
    </div>

</div>

<div id="detailModal" class="modal-overlay" onclick="window.closeModal(event)">
    <div class="modal-content">
        <div class="modal-header" style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h3 style="margin:0; color:#0277bd;">D√©tail Dossier</h3>
            <span style="cursor:pointer; font-size:20px;" onclick="window.closeModalBtn()">&times;</span>
        </div>
        <div id="modal-body-content" style="margin-top:15px;"></div>
    </div>
</div>

<div id="toast">Fiche enregistr√©e !</div>

<script type="module">
    // --- MODE SIMULATION (Donn√©es Dentaires R√©alistes) ---
    let database = []; 
    let isAdmin = false;

    window.generateSimulatedData = function() {
        let simulatedDB = [];
        const professions = ["Etudiant", "Commer√ßant", "Sans emploi", "Fonctionnaire", "Chauffeur", "Cultivateur"];
        const residences = ["Makala", "Ngaba", "Lemba", "Kalamu", "Selembao"];
        
        // G√©n√©ration de 200 cas fictifs bas√©s sur l'√©pid√©miologie courante √† Kinshasa
        for (let i = 1; i <= 200; i++) {
            let age = Math.floor(Math.random() * 75) + 5; // 5 √† 80 ans
            let sexe = Math.random() > 0.45 ? "F" : "M"; // L√©g√®re pr√©dominance f√©minine souvent observ√©e
            
            // Logique Clinique (Intelligence simul√©e)
            let indication, dent, typeExt, complication, radio;
            let typeExtCode = "Simple";
            
            // D√©terminer l'indication selon l'√¢ge
            let randIndic = Math.random();
            if (age < 15) {
                // Enfants : Carie ou Ortho
                indication = randIndic > 0.7 ? "Indication orthodontique" : "Carie avanc√©e";
                dent = [51,52,53,54,55,61,62,63,64,65,71,72,73,74,75,81,82,83,84,85][Math.floor(Math.random()*20)]; // Dents lact√©ales (simplifi√©)
            } else if (age > 15 && age < 30) {
                // Jeunes adultes : Dents de sagesse (incluses) ou Carie
                if (randIndic > 0.6) {
                    indication = "Dent incluse/enclav√©e";
                    dent = [18, 28, 38, 48][Math.floor(Math.random()*4)];
                    typeExtCode = "Chirurgicale";
                } else {
                    indication = "Carie avanc√©e";
                    dent = Math.floor(Math.random() * 32) + 11;
                }
            } else {
                // Adultes/Vieux : Paro ou Carie terminale
                if (randIndic > 0.6) {
                    indication = "Maladie parodontale";
                } else {
                    indication = "Carie avanc√©e"; // Reste la cause #1
                }
                dent = Math.floor(Math.random() * 32) + 11;
            }

            // Complications (Plus rares)
            let randComp = Math.random();
            if (randComp > 0.90) complication = "Alv√©olite";
            else if (randComp > 0.95) complication = "H√©morragie";
            else complication = "Aucune";

            // Radio : Souvent Oui pour Incluses/Chirurgie
            radio = (typeExtCode === "Chirurgicale" || indication === "Complication pulpo-p√©riapicale") ? "Oui" : (Math.random() > 0.7 ? "Oui" : "Non");

            simulatedDB.push({
                id: "EXT-" + i.toString().padStart(3, '0'),
                date: "2023-" + (Math.floor(Math.random()*12)+1).toString().padStart(2,'0') + "-15",
                age: age,
                sexe: sexe,
                prof: professions[Math.floor(Math.random() * professions.length)],
                resid: residences[Math.floor(Math.random() * residences.length)],
                motif: "Douleur",
                dent: dent,
                arcade: (dent >= 11 && dent <= 28) ? "Maxillaire" : "Mandibulaire",
                indication: indication,
                radio: radio,
                typeExt: typeExtCode,
                complication: complication,
                enqueteur: "Dr Simul"
            });
        }
        return simulatedDB;
    };

    // Chargement initial
    database = window.generateSimulatedData();
    setTimeout(() => {
        window.updateUI();
        showToast("200 Dossiers dentaires charg√©s (Simulation Makala)");
    }, 500);

    // --- LOGIQUE METIER ---

    window.requestAdmin = function() {
        if(isAdmin) return; 
        let code = prompt("Code Chef de Service (ex: makala) :"); 
        if(code === "makala") {
            isAdmin = true;
            document.querySelectorAll('.admin-only').forEach(el => {
                el.classList.add('admin-visible');
            });
            document.getElementById('btn-auth').style.display = 'none';
            alert("Acc√®s valid√©. Vous pouvez voir la Matrice et les Stats.");
            window.switchTab(3); // Aller direct aux stats
        } else {
            alert("Code incorrect !");
        }
    };

    window.saveRecord = function() {
        [span_6](start_span)// R√©cup√©ration des champs[span_6](end_span)
        let id = document.getElementById('id-dossier').value;
        let indic = document.getElementById('indication').value;
        let dent = document.getElementById('dent').value;

        if(!id || !indic || !dent) {
            alert("Erreur : ID, Dent et Indication sont obligatoires !");
            return;
        }

        const newEntry = {
            id: id,
            date: document.getElementById('date-consultation').value,
            age: document.getElementById('age').value,
            sexe: document.getElementById('sexe').value,
            prof: document.getElementById('profession').value,
            resid: document.getElementById('residence').value,
            motif: document.getElementById('motif').value,
            dent: dent,
            arcade: document.getElementById('arcade').value,
            indication: indic,
            radio: document.getElementById('radio').value,
            typeExt: document.getElementById('type-ext').value,
            complication: document.getElementById('complication').value,
            enqueteur: document.getElementById('enqueteur').value
        };

        database.unshift(newEntry); // Ajouter au d√©but
        window.updateUI();
        showToast("Fiche ajout√©e avec succ√®s !");
        document.getElementById('dentalForm').reset();
    };

    // Suppression & Gestion
    window.deleteOne = function(index) {
        if(confirm("Supprimer ce dossier ?")) {
            database.splice(index, 1);
            updateUI();
        }
    };

    window.deleteSelected = function() {
        if(!confirm("Confirmer la suppression multiple ?")) return;
        const checkboxes = Array.from(document.querySelectorAll('.row-check'));
        for (let i = checkboxes.length - 1; i >= 0; i--) {
            if (checkboxes[i].checked) database.splice(i, 1);
        }
        updateUI();
    };

    window.toggleSelectAll = function(source) {
        document.querySelectorAll('.row-check').forEach(cb => cb.checked = source.checked);
        window.toggleDeleteButton();
    };

    window.toggleDeleteButton = function() {
        const checked = document.querySelectorAll('.row-check:checked').length;
        document.getElementById('btn-delete-multi').style.display = checked > 0 ? 'block' : 'none';
    };

    window.viewDetails = function(index) {
        let d = database[index];
        let html = `
            <div class="detail-row"><span>ID Dossier</span><b>${d.id}</b></div>
            <div class="detail-row"><span>Date</span><span>${d.date}</span></div>
            <div class="detail-row"><span>Patient</span><span>${d.age} ans / ${d.sexe}</span></div>
            <div class="detail-row"><span>R√©sidence</span><span>${d.resid}</span></div>
            <br>
            <strong style="color:#0277bd">DONN√âES CLINIQUES</strong>
            <div class="detail-row"><span>Dent</span><b>#${d.dent} (${d.arcade})</b></div>
            <div class="detail-row"><span>Indication</span><b>${d.indication}</b></div>
            <div class="detail-row"><span>Radio</span><span>${d.radio}</span></div>
            <div class="detail-row"><span>Type Extraction</span><span>${d.typeExt}</span></div>
            <div class="detail-row" style="background:#ffebee"><span>Complication</span><b style="color:#c62828">${d.complication}</b></div>
        `;
        document.getElementById('modal-body-content').innerHTML = html;
        document.getElementById('detailModal').style.display = 'flex';
    };

    window.closeModal = function(e) { if(e.target.id === 'detailModal') document.getElementById('detailModal').style.display = 'none'; };
    window.closeModalBtn = function() { document.getElementById('detailModal').style.display = 'none'; };

    // --- VISUALISATION & MISE A JOUR ---
    window.updateUI = function() {
        document.getElementById('count-badge').textContent = database.length;
        document.getElementById('n-total').textContent = database.length;
        document.getElementById('stat-n').textContent = database.length;

        // Remplir le tableau
        const tbody = document.getElementById('database-body');
        let displayData = database.slice(0, 50); // Afficher les 50 derniers pour la perf
        
        tbody.innerHTML = displayData.map((row, index) => `
            <tr>
                <td><input type="checkbox" class="row-check" onclick="window.toggleDeleteButton()"></td>
                <td><b>${row.id}</b></td>
                <td>${row.age} ans (${row.sexe})</td>
                <td>#${row.dent}</td>
                <td>${row.indication}</td>
                <td><span style="padding:2px 6px; border-radius:4px; background:${row.typeExt === 'Chirurgicale' ? '#fff3e0' : '#e8f5e9'}">${row.typeExt}</span></td>
                <td style="color:${row.complication !== 'Aucune' ? 'red' : 'green'}">${row.complication}</td>
                <td>
                    <button class="btn-view-single" onclick="window.viewDetails(${index})">Voir</button>
                    <button class="btn-view-single" style="color:red; border-color:red;" onclick="window.deleteOne(${index})">X</button>
                </td>
            </tr>
        `).join('');

        if(isAdmin) window.updateAnalytics();
    };

    window.updateAnalytics = function() {
        if(database.length === 0) return;

        [span_7](start_span)// 1. Graphique Indications[span_7](end_span)
        let indicMap = {};
        database.forEach(r => indicMap[r.indication] = (indicMap[r.indication]||0)+1);
        let sortedIndic = Object.entries(indicMap).sort((a,b) => b[1] - a[1]);
        
        document.getElementById('graph-indications').innerHTML = sortedIndic.map(([k,v]) => {
            let p = Math.round((v/database.length)*100);
            return `<div class="bar-container"><div class="bar-label">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${p}%; background:#0277bd;">${p}%</div></div><div class="bar-value">${v}</div></div>`;
        }).join('');

        [span_8](start_span)// 2. Type d'extraction[span_8](end_span)
        let typeS = database.filter(r => r.typeExt === 'Simple').length;
        let typeC = database.filter(r => r.typeExt === 'Chirurgicale').length;
        document.getElementById('graph-type').innerHTML = `
            <div class="bar-container"><div class="bar-label">Simple</div><div class="bar-track"><div class="bar-fill" style="width:${Math.round(typeS/database.length*100)}%; background:#4caf50;">${Math.round(typeS/database.length*100)}%</div></div></div>
            <div class="bar-container"><div class="bar-label">Chirurgicale</div><div class="bar-track"><div class="bar-fill" style="width:${Math.round(typeC/database.length*100)}%; background:#ff9800;">${Math.round(typeC/database.length*100)}%</div></div></div>
        `;

        [span_9](start_span)// 3. Complications[span_9](end_span)
        let compMap = {};
        database.forEach(r => compMap[r.complication] = (compMap[r.complication]||0)+1);
        delete compMap["Aucune"]; // On montre juste les probl√®mes
        document.getElementById('graph-comps').innerHTML = Object.entries(compMap).length > 0 ? Object.entries(compMap).map(([k,v]) => {
            let p = Math.round((v/database.length)*100);
            return `<div class="bar-container"><div class="bar-label" style="color:#c62828">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.max(p, 5)}%; background:#c62828;">${p}%</div></div><div class="bar-value">${v}</div></div>`;
        }).join('') : "<p>Aucune complication enregistr√©e.</p>";

        // 4. Analyse Crois√©e (Age vs Indication)
        // Groupes : Enfants (<15), Jeunes (15-35), Adultes (36-55), Vieux (>55)
        let groups = [
            {l: "Enfants (<15 ans)", filter: r => r.age < 15},
            {l: "Jeunes (15-35 ans)", filter: r => r.age >= 15 && r.age <= 35},
            {l: "Adultes (36-55 ans)", filter: r => r.age > 35 && r.age <= 55},
            {l: "Seniors (>55 ans)", filter: r => r.age > 55}
        ];

        document.getElementById('cross-body').innerHTML = groups.map(g => {
            let subset = database.filter(g.filter);
            if(subset.length === 0) return `<tr><td>${g.l}</td><td colspan="2">-</td></tr>`;
            
            // Trouver l'indication top pour ce groupe
            let counts = {};
            subset.forEach(r => counts[r.indication] = (counts[r.indication]||0)+1);
            let top = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0];
            
            return `<tr>
                <td style="padding:10px; border-bottom:1px solid #eee;"><b>${g.l}</b> (n=${subset.length})</td>
                <td style="padding:10px; border-bottom:1px solid #eee; color:#0277bd;">${top[0]}</td>
                <td style="padding:10px; border-bottom:1px solid #eee;">${Math.round((top[1]/subset.length)*100)}% du groupe</td>
            </tr>`;
        }).join('');
    };

    // --- UTILITAIRES ---
    window.switchTab = function(i) {
        document.querySelectorAll('.form-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('content-'+i).classList.add('active');
        document.querySelectorAll('.tab')[i-1].classList.add('active');
    };

    function showToast(message) {
        var x = document.getElementById("toast");
        x.className = "show";
        x.innerText = message;
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    window.exportToCSV = function() {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "ID,Date,Age,Sexe,Profession,Residence,Motif,Dent,Arcade,Indication,Radio,TypeExtraction,Complication\n";
        database.forEach(r => {
            let row = `${r.id},${r.date},${r.age},${r.sexe},"${r.prof}","${r.resid}","${r.motif}",${r.dent},${r.arcade},"${r.indication}",${r.radio},${r.typeExt},"${r.complication}"`;
            csvContent += row + "\n";
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "Makala_Extraction_Data.csv");
        document.body.appendChild(link);
        link.click();
    };
</script>

</body>
</html>
