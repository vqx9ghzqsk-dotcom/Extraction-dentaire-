<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire √âtude Clinique - HGR Makala</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --blue: #3498db;
            --green: #27ae60;
            --light: #ecf0f1;
            --danger: #e74c3c;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; color: #333; }
        
        /* NAVIGATION */
        .navbar { background: white; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
        .brand { font-weight: bold; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .nav-links { display: flex; gap: 5px; }
        .nav-btn { background: none; border: none; padding: 20px 15px; cursor: pointer; font-weight: 600; color: #7f8c8d; border-bottom: 3px solid transparent; transition: 0.3s; }
        .nav-btn:hover { background: #f8f9fa; color: var(--blue); }
        .nav-btn.active { border-bottom: 3px solid var(--blue); color: var(--blue); }

        /* CONTENT */
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CARDS & FORMS */
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .card-header { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; font-weight: bold; color: var(--primary); text-transform: uppercase; font-size: 0.9rem; }
        
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem; box-sizing: border-box; }
        input:focus, select:focus { border-color: var(--blue); outline: none; }

        /* BUTTONS */
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--blue); color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: var(--green); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: var(--primary); }
        .cross-tab th { background: #eaf2f8; text-align: center; }
        .cross-tab td { text-align: center; }
        .highlight-cell { background-color: #e8f6f3; font-weight: bold; color: var(--green); }

        /* DENTAL SELECTOR */
        .teeth-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin: 10px 0; }
        .tooth { width: 35px; height: 35px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; border-radius: 4px; }
        .tooth:hover { background: #f0f0f0; }
        .tooth.selected { background: var(--blue); color: white; border-color: var(--blue); }

        /* STATS BOXES */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: white; padding: 15px; border-radius: 8px; box-shadow: var(--shadow); border-left: 4px solid var(--blue); }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .stat-lbl { font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase; }

        /* PRINT */
        @media print {
            .navbar, .btn, .no-print { display: none; }
            .card { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="brand">
        <span style="font-size: 1.5rem;">ü¶∑</span> √âTUDE HGR MAKALA
    </div>
    <div class="nav-links">
        <button class="nav-btn active" onclick="switchTab('tab-collecte')">1. Collecte</button>
        <button class="nav-btn" onclick="switchTab('tab-matrice')">2. Matrice</button>
        <button class="nav-btn" onclick="switchTab('tab-analyse')">3. Analyse & R√©sultats</button>
        <button class="nav-btn" onclick="switchTab('tab-concl')">4. Conclusion</button>
    </div>
</nav>

<div class="container">

    <div id="tab-collecte" class="tab-content active">
        <div class="card">
            <div class="card-header">Saisie Dossier Patient (R√©trospectif)</div>
            <form id="dataForm">
                <div class="grid-4">
                    <div class="form-group">
                        <label>N¬∞ Dossier</label>
                        <input type="text" id="id_dossier" placeholder="Ex: 2023-001" required>
                    </div>
                    <div class="form-group">
                        <label>Date de l'acte</label>
                        <input type="date" id="date_acte" required>
                    </div>
                </div>

                <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
                
                <div class="grid-4">
                    <div class="form-group">
                        <label>√Çge (ans)</label>
                        <input type="number" id="age" min="1" max="110" required>
                    </div>
                    <div class="form-group">
                        <label>Sexe</label>
                        <select id="sexe" required>
                            <option value="M">Masculin</option>
                            <option value="F">F√©minin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Profession</label>
                        <select id="profession">
                            <option value="Sans emploi">Sans emploi</option>
                            <option value="Etudiant">√âl√®ve/√âtudiant</option>
                            <option value="Ouvrier">Ouvrier/Artisan</option>
                            <option value="Fonctionnaire">Fonctionnaire</option>
                            <option value="Commerce">Commer√ßant(e)</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>R√©sidence</label>
                        <select id="residence">
                            <option value="Makala">C. Makala (Local)</option>
                            <option value="Bumbu">C. Bumbu</option>
                            <option value="Ngaba">C. Ngaba</option>
                            <option value="Autre">Autre Commune</option>
                        </select>
                    </div>
                </div>

                <div class="card-header" style="margin-top:20px;">Donn√©es Cliniques</div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Motif de consultation</label>
                        <input type="text" id="motif" placeholder="Douleur, Gonflement, Esth√©tique...">
                    </div>
                    <div class="form-group">
                        <label>Arcade</label>
                        <select id="arcade">
                            <option value="Maxillaire">Maxillaire (Haut)</option>
                            <option value="Mandibule">Mandibule (Bas)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Dent Concern√©e (S√©lectionner)</label>
                    <div class="teeth-container" id="teeth-grid">
                        </div>
                    <input type="hidden" id="dent_selected">
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Indication (Diagnostic)</label>
                        <select id="indication" required>
                            <option value="Carie">Carie dentaire (et complications)</option>
                            <option value="Parodonte">Maladie Parodontale (Mobilit√©)</option>
                            <option value="Trauma">Traumatisme</option>
                            <option value="Ortho">Orthodontie</option>
                            <option value="Incluse">Dent Incluse/Enclav√©e</option>
                            <option value="Prothese">Raisons Proth√©tiques</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Radiographie pr√©-op ?</label>
                        <select id="radio">
                            <option value="Non">Non</option>
                            <option value="Oui">Oui</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Type d'Extraction</label>
                        <select id="type_ext">
                            <option value="Simple">Simple (√âl√©vateur/Davier)</option>
                            <option value="Chirurgicale">Chirurgicale (Alv√©olectomie/S√©paration)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Complications Post-op</label>
                        <select id="complication">
                            <option value="Aucune">Aucune</option>
                            <option value="Hemorragie">H√©morragie</option>
                            <option value="Alveolite">Alv√©olite</option>
                            <option value="Infection">Infection/Abc√®s</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="addData()">üíæ ENREGISTRER LE DOSSIER</button>
            </form>
        </div>
    </div>

    <div id="tab-matrice" class="tab-content">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="card-header" style="margin:0; border:none;">Matrice des Donn√©es (Base de donn√©es)</div>
                <button class="btn btn-success" onclick="exportCSV()">üì• Exporter CSV (Excel)</button>
            </div>
            <div style="overflow-x:auto; margin-top:20px;">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>ID</th><th>Age</th><th>Sexe</th><th>Prof.</th><th>R√©sidence</th><th>Indication</th><th>Dent</th><th>Type</th><th>Comp.</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="btn btn-danger" style="margin-top:20px;" onclick="clearData()">‚ö†Ô∏è Effacer toute la base</button>
        </div>
    </div>

    <div id="tab-analyse" class="tab-content">
        
        <div class="card">
            <div class="card-header">1. Statistiques Descriptives G√©n√©rales</div>
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-val" id="stat-n">0</div>
                    <div class="stat-lbl">Effectif Total (N)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="stat-age">0</div>
                    <div class="stat-lbl">√Çge Moyen ¬± ET</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="stat-sexratio">0</div>
                    <div class="stat-lbl">Sexe Ratio (H/F)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="stat-comp-rate">0%</div>
                    <div class="stat-lbl">Taux Complications</div>
                </div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <div class="card-header">Pr√©valence des Indications</div>
                <canvas id="chartIndications"></canvas>
            </div>
            <div class="card">
                <div class="card-header">R√©partition par Sexe</div>
                <canvas id="chartSexe"></canvas>
            </div>
        </div>

        <h3 style="color:var(--primary); margin-top:30px;">2. √âtude Analytique (Tableaux Crois√©s)</h3>
        
        <div class="card">
            <div class="card-header">Tableau 1 : Association √Çge (Group√©) vs Indication</div>
            <p style="font-size:0.8rem; color:#666; margin-top:-10px; margin-bottom:15px;">Permet d'observer si certaines pathologies sont li√©es √† des tranches d'√¢ge sp√©cifiques.</p>
            <div id="crossTabAgeIndic"></div>
        </div>

        <div class="card">
            <div class="card-header">Tableau 2 : Association Sexe vs Indication</div>
            <div id="crossTabSexeIndic"></div>
        </div>

        <div class="card">
            <div class="card-header">Tableau 3 : Indication vs Type d'Extraction</div>
            <p style="font-size:0.8rem; color:#666;">V√©rification de la coh√©rence clinique (ex: Dents incluses = Chirurgie ?)</p>
            <div id="crossTabIndicType"></div>
        </div>

    </div>

    <div id="tab-concl" class="tab-content">
        <div class="card">
            <div class="card-header">G√©n√©rateur de Rapport Automatique</div>
            <div id="autoReport" style="line-height: 1.8; color: #2c3e50;">
                <p><em>Veuillez entrer des donn√©es pour g√©n√©rer le rapport.</em></p>
            </div>
        </div>
    </div>

</div>

<script>
    // --- VARIABLES GLOBALES ---
    let db = JSON.parse(localStorage.getItem('makalaDB')) || [];
    let charts = {};

    // --- INITIALISATION ---
    window.onload = function() {
        renderTeeth();
        updateAll();
    };

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        
        if(id === 'tab-analyse') renderCharts();
        if(id === 'tab-concl') generateReport();
    }

    function renderTeeth() {
        const container = document.getElementById('teeth-grid');
        // FDI Notation
        const teeth = [
            18,17,16,15,14,13,12,11, 21,22,23,24,25,26,27,28,
            48,47,46,45,44,43,42,41, 31,32,33,34,35,36,37,38
        ];
        teeth.forEach(t => {
            let div = document.createElement('div');
            div.className = 'tooth';
            div.innerText = t;
            div.onclick = function() {
                document.querySelectorAll('.tooth').forEach(el => el.classList.remove('selected'));
                this.classList.add('selected');
                document.getElementById('dent_selected').value = t;
            }
            container.appendChild(div);
        });
    }

    // --- GESTION DES DONN√âES ---
    function addData() {
        const fields = ['id_dossier', 'date_acte', 'age', 'sexe', 'profession', 'residence', 'motif', 'arcade', 'dent_selected', 'indication', 'radio', 'type_ext', 'complication'];
        let record = {};
        
        // Validation simple
        if(!document.getElementById('id_dossier').value || !document.getElementById('age').value) {
            alert("Veuillez remplir au moins l'ID et l'√Çge.");
            return;
        }

        fields.forEach(f => record[f] = document.getElementById(f).value);
        record.age = parseInt(record.age);

        db.push(record);
        localStorage.setItem('makalaDB', JSON.stringify(db));
        
        alert("Dossier enregistr√© !");
        document.getElementById('dataForm').reset();
        document.querySelectorAll('.tooth').forEach(el => el.classList.remove('selected'));
        updateAll();
    }

    function updateAll() {
        renderTable();
        calculateStats();
    }

    function renderTable() {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        db.forEach((row, index) => {
            let tr = `<tr>
                <td>${row.id_dossier}</td>
                <td>${row.age}</td>
                <td>${row.sexe}</td>
                <td>${row.profession}</td>
                <td>${row.residence}</td>
                <td>${row.indication}</td>
                <td>${row.dent_selected}</td>
                <td>${row.type_ext}</td>
                <td style="color:${row.complication !== 'Aucune' ? 'red' : 'green'}">${row.complication}</td>
                <td><button class="btn btn-danger" style="padding:2px 8px; font-size:10px" onclick="deleteRow(${index})">X</button></td>
            </tr>`;
            tbody.innerHTML += tr;
        });
    }

    function deleteRow(index) {
        if(confirm('Supprimer cette ligne ?')) {
            db.splice(index, 1);
            localStorage.setItem('makalaDB', JSON.stringify(db));
            updateAll();
        }
    }

    function clearData() {
        if(confirm('ATTENTION : Voulez-vous vraiment TOUT effacer ?')) {
            db = [];
            localStorage.setItem('makalaDB', JSON.stringify(db));
            updateAll();
            location.reload();
        }
    }

    // --- ANALYSE STATISTIQUE (LE C≈íUR DU M√âMOIRE) ---
    function calculateStats() {
        const n = db.length;
        if(n === 0) return;

        // 1. Descriptif
        document.getElementById('stat-n').innerText = n;

        // Age Moyen & Ecart Type (SD)
        const ages = db.map(r => r.age);
        const meanAge = ages.reduce((a,b) => a+b, 0) / n;
        const variance = ages.reduce((a,b) => a + Math.pow(b - meanAge, 2), 0) / n;
        const sdAge = Math.sqrt(variance);
        document.getElementById('stat-age').innerText = `${meanAge.toFixed(1)} ¬± ${sdAge.toFixed(1)}`;

        // Sexe Ratio
        const males = db.filter(r => r.sexe === 'M').length;
        const females = n - males;
        document.getElementById('stat-sexratio').innerText = females > 0 ? (males/females).toFixed(2) : males;

        // Taux complications
        const comps = db.filter(r => r.complication !== 'Aucune').length;
        document.getElementById('stat-comp-rate').innerText = ((comps/n)*100).toFixed(1) + '%';

        // 2. Tableaux Crois√©s (Logique Pivot)
        
        // Groupes d'√¢ge
        const ageGroups = ['0-19', '20-39', '40-59', '60+'];
        const indications = [...new Set(db.map(r => r.indication))];

        // Helper pour cat√©goriser √¢ge
        const getAgeGroup = (age) => {
            if(age < 20) return '0-19';
            if(age < 40) return '20-39';
            if(age < 60) return '40-59';
            return '60+';
        };

        // G√©n√©ration Crosstab 1: Age Group x Indication
        generateCrossTab('crossTabAgeIndic', ageGroups, indications, (r) => getAgeGroup(r.age), (r) => r.indication);

        // G√©n√©ration Crosstab 2: Sexe x Indication
        generateCrossTab('crossTabSexeIndic', ['M', 'F'], indications, (r) => r.sexe, (r) => r.indication);

        // G√©n√©ration Crosstab 3: Indication x Type Extraction
        generateCrossTab('crossTabIndicType', indications, ['Simple', 'Chirurgicale'], (r) => r.indication, (r) => r.type_ext);
    }

    function generateCrossTab(containerId, rowLabels, colLabels, rowAccessor, colAccessor) {
        let html = `<table class="cross-tab"><thead><tr><th>Variable</th>`;
        colLabels.forEach(c => html += `<th>${c}</th>`);
        html += `<th>Total</th></tr></thead><tbody>`;

        rowLabels.forEach(rowLbl => {
            html += `<tr><td><b>${rowLbl}</b></td>`;
            let rowTotal = 0;
            colLabels.forEach(colLbl => {
                const count = db.filter(r => rowAccessor(r) === rowLbl && colAccessor(r) === colLbl).length;
                rowTotal += count;
                // Calcul % ligne pour analyse
                const pct = rowTotal > 0 ? Math.round((count/rowTotal)*100) : 0; // Simplifi√© ici
                // Cellule
                html += `<td class="${count > 0 ? 'highlight-cell' : ''}">${count}</td>`;
            });
            html += `<td><strong>${rowTotal}</strong></td></tr>`;
        });
        html += `</tbody></table>`;
        document.getElementById(containerId).innerHTML = html;
    }

    function renderCharts() {
        if(db.length === 0) return;

        const ctx1 = document.getElementById('chartIndications').getContext('2d');
        const ctx2 = document.getElementById('chartSexe').getContext('2d');

        // Data Prep Indication
        const counts = {};
        db.forEach(x => { counts[x.indication] = (counts[x.indication] || 0) + 1; });
        
        if(charts.c1) charts.c1.destroy();
        charts.c1 = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: Object.keys(counts),
                datasets: [{
                    label: "Nombre de cas",
                    data: Object.values(counts),
                    backgroundColor: '#3498db'
                }]
            }
        });

        // Data Prep Sexe
        const m = db.filter(r => r.sexe === 'M').length;
        const f = db.filter(r => r.sexe === 'F').length;

        if(charts.c2) charts.c2.destroy();
        charts.c2 = new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: ['Masculin', 'F√©minin'],
                datasets: [{
                    data: [m, f],
                    backgroundColor: ['#2980b9', '#e74c3c']
                }]
            }
        });
    }

    // --- RAPPORT AUTOMATIQUE ---
    function generateReport() {
        if(db.length === 0) return;

        // Analyse Indication Dominante
        const counts = {};
        db.forEach(x => { counts[x.indication] = (counts[x.indication] || 0) + 1; });
        const topIndic = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
        
        // Moyenne √¢ge
        const ages = db.map(r => r.age);
        const meanAge = (ages.reduce((a,b) => a+b, 0) / db.length).toFixed(1);

        let html = `
            <h3>Synth√®se des R√©sultats</h3>
            <p>Au terme de cette √©tude r√©trospective men√©e √† l'H√¥pital G√©n√©ral de R√©f√©rence de Makala, portant sur un √©chantillon de <strong>${db.length} dossiers</strong> :</p>
            <ul>
                <li>La population d'√©tude pr√©sente une moyenne d'√¢ge de <strong>${meanAge} ans</strong>.</li>
                <li>L'indication principale d'extraction dentaire est <strong>"${topIndic}"</strong>, repr√©sentant ${counts[topIndic]} cas.</li>
                <li>Le taux de complication post-op√©ratoire s'√©l√®ve √† <strong>${document.getElementById('stat-comp-rate').innerText}</strong>.</li>
            </ul>

            <h3>Recommandations Cliniques</h3>
            <ol>
                <li>
                    <strong>Pr√©vention cibl√©e :</strong> Puisque "${topIndic}" est pr√©dominant, les efforts de sensibilisation dans la zone de sant√© de Makala doivent se focaliser sur cette pathologie.
                </li>
                <li>
                    <strong>Gestion des donn√©es :</strong> La syst√©matisation de la saisie des dossiers (telle que simul√©e ici) est cruciale pour le suivi longitudinal des patients.
                </li>
            </ol>
            <p style="font-size:0.8rem; color:grey; margin-top:20px;">*Note : Ce rapport est g√©n√©r√© automatiquement bas√© sur les donn√©es saisies. Une validation statistique via un logiciel d√©di√© (SPSS/R) est recommand√©e pour les tests de significativit√© (p-value) dans le m√©moire final.*</p>
        `;
        document.getElementById('autoReport').innerHTML = html;
    }

    function exportCSV() {
        let csv = "ID;Date;Age;Sexe;Profession;Residence;Motif;Arcade;Dent;Indication;Radio;Type;Complication\n";
        db.forEach(r => {
            csv += `${r.id_dossier};${r.date_acte};${r.age};${r.sexe};${r.profession};${r.residence};${r.motif};${r.arcade};${r.dent_selected};${r.indication};${r.radio};${r.type_ext};${r.complication}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "donnees_makala_complet.csv";
        link.click();
    }
</script>

</body>
</html>
