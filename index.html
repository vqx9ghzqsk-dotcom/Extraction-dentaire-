<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire d'√âtude Clinique - Extraction Dentaire HGR Makala</title>
    <style>
        /* --- DESIGN SYST√àME (Format Ordinateur) --- */
        :root {
            --primary: #0277bd;
            --secondary: #00acc1;
            --accent: #f57c00;
            --bg: #f4f7f6;
            --text: #2c3e50;
            --white: #ffffff;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; }

        /* Navigation Lat√©rale ou Top Bar */
        .navbar { background: var(--white); height: 70px; display: flex; align-items: center; padding: 0 30px; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000; }
        .logo { font-weight: 800; color: var(--primary); font-size: 20px; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; }
        
        .nav-tabs { display: flex; margin-left: 50px; gap: 5px; height: 100%; }
        .tab-btn { border: none; background: none; padding: 0 20px; font-weight: 600; color: #7f8c8d; cursor: pointer; transition: 0.3s; border-bottom: 3px solid transparent; height: 100%; font-size: 14px; }
        .tab-btn:hover { color: var(--primary); background: #f0f7f9; }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #f0f7f9; }

        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }

        /* Conteneurs Onglets */
        .page { display: none; animation: fadeIn 0.4s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARTES ET FORMULAIRES */
        .card { background: var(--white); border-radius: 12px; padding: 30px; box-shadow: var(--shadow); margin-bottom: 25px; border: 1px solid #eef2f3; }
        .section-header { border-left: 5px solid var(--primary); padding-left: 15px; margin: 25px 0 20px 0; color: var(--primary); font-size: 16px; text-transform: uppercase; font-weight: bold; }

        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; }

        .form-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-weight: 700; font-size: 13px; color: #50667a; }
        input, select, textarea { padding: 12px; border: 1px solid #dcdfe6; border-radius: 8px; font-size: 14px; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(2, 119, 189, 0.1); }

        /* Style sp√©cifique pour les cases √† cocher (Grille Dentaire) */
        .dental-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; text-align: center; background: #f9fafb; padding: 15px; border-radius: 10px; }
        .tooth-btn { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; cursor: pointer; background: white; }
        .tooth-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* BOUTONS */
        .btn-main { background: var(--primary); color: white; border: none; padding: 15px 35px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; font-size: 15px; }
        .btn-main:hover { background: #01579b; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(2, 119, 189, 0.3); }

        /* TABLEAUX (Matrice) */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th { background: #f8fabb; color: var(--text); padding: 15px; text-align: left; font-size: 13px; border-bottom: 2px solid #edf2f7; }
        td { padding: 15px; border-bottom: 1px solid #edf2f7; font-size: 13px; }
        tr:hover { background: #fcfdfe; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .badge-blue { background: #e1f5fe; color: #0277bd; }

        /* ANALYSE ET STATS */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); text-align: center; }
        .stat-number { font-size: 28px; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 12px; color: #7f8c8d; margin-top: 5px; }

        .chart-container { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); height: 300px; display: flex; align-items: flex-end; gap: 10px; padding-top: 50px; }
        .bar { background: var(--primary); border-radius: 4px 4px 0 0; position: relative; flex: 1; transition: 0.5s; }
        .bar:hover { background: var(--secondary); }
        .bar-label { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: bold; width: 100%; text-align: center; }
        .bar-name { position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%) rotate(-45deg); font-size: 10px; white-space: nowrap; }

    </style>
</head>
<body>

<div class="navbar">
    <div class="logo">ü¶∑ CLINIC-DATA <span>| MAKALA</span></div>
    <div class="nav-tabs">
        <button class="tab-btn active" onclick="openTab(event, 'tab-collecte')">1. COLLECTE DE DONN√âES</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-matrice')">2. MATRICE & CODIFICATION</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-analyse')">3. ANALYSE STATISTIQUE</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-rapport')">4. RECOMMANDATIONS</button>
    </div>
</div>

<div class="container">

    <div id="tab-collecte" class="page active">
        <div class="card">
            <h2 style="margin-top:0">Fiche d'enqu√™te : Extraction Dentaire</h2>
            <p style="color:#7f8c8d; font-size: 14px;">Veuillez remplir les informations issues du dossier patient de l'HGR Makala.</p>
            
            <form id="extractionForm">
                <div class="section-header">I. Identification & Chronologie</div>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Num√©ro de Dossier (ID)</label>
                        <input type="text" id="id_dossier" placeholder="Ex: 2024-EXT-001" required>
                    </div>
                    <div class="form-group">
                        <label>Date de Consultation</label>
                        <input type="date" id="date_consultation" required>
                    </div>
                    <div class="form-group">
                        <label>Nom de l'Enqu√™teur</label>
                        <input type="text" id="enqueteur" placeholder="Pr√©nom Nom">
                    </div>
                </div>

                <div class="section-header">II. Profil Sociod√©mographique</div>
                <div class="grid-3">
                    <div class="form-group">
                        <label>√Çge du Patient (ans)</label>
                        <input type="number" id="age" min="1" max="110">
                    </div>
                    <div class="form-group">
                        <label>Sexe</label>
                        <select id="sexe">
                            <option value="1">1. Masculin</option>
                            <option value="2">2. F√©minin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Profession</label>
                        <input type="text" id="profession" placeholder="Secteur d'activit√©">
                    </div>
                </div>

                <div class="section-header">III. Examen Clinique & Localisation</div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Motif de consultation</label>
                        <textarea id="motif" rows="2" placeholder="Description de la plainte..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Arcade concern√©e</label>
                        <select id="arcade">
                            <option value="1">1. Maxillaire (Haut)</option>
                            <option value="2">2. Mandibulaire (Bas)</option>
                        </select>
                    </div>
                </div>
                
                <p style="font-weight: bold; font-size: 13px; margin: 15px 0 5px 0;">S√©lectionner la dent (Num√©rotation ISO) :</p>
                <div class="dental-grid" id="tooth-selector">
                    </div>

                <div class="section-header">IV. Indications (Codification Extraction)</div>
                <div class="grid-2">
                    <div class="form-group" style="background: #f0f7f9; padding: 20px; border-radius: 12px; border: 1px solid var(--primary);">
                        <label style="color: var(--primary); font-size: 14px;">Indication principale (Codifi√©e)</label>
                        <select id="indication" style="border: 2px solid var(--primary);">
                            <option value="1">1. Carie avanc√©e (D√©labrement)</option>
                            <option value="2">2. Complication pulpo-p√©riapicale</option>
                            <option value="3">3. Maladie parodontale (Mobilit√©)</option>
                            <option value="4">4. Dent incluse/enclav√©e</option>
                            <option value="5">5. Traumatisme dentaire</option>
                            <option value="6">6. Indication orthodontique</option>
                            <option value="7">7. Autres causes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Examens Compl√©mentaires</label>
                        <div style="display:flex; gap:20px; align-items:center; height:100%;">
                            <label style="display:flex; align-items:center; gap:8px; font-weight:normal;">
                                <input type="radio" name="radio_bool" value="1"> Radiographie r√©alis√©e
                            </label>
                            <label style="display:flex; align-items:center; gap:8px; font-weight:normal;">
                                <input type="radio" name="radio_bool" value="0" checked> Aucune radio
                            </label>
                        </div>
                    </div>
                </div>

                <div class="section-header">V. Proc√©dure & Complications</div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Type d'extraction</label>
                        <select id="type_ext">
                            <option value="1">1. Simple</option>
                            <option value="2">2. Chirurgicale (Alv√©olectomie)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Complications post-op√©ratoires</label>
                        <select id="complication">
                            <option value="0">0. Aucune</option>
                            <option value="1">1. H√©morragie</option>
                            <option value="2">2. Infection / Abc√®s</option>
                            <option value="3">3. Alv√©olite</option>
                            <option value="4">4. Autres</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top:40px; text-align: right;">
                    <button type="button" class="btn-main" onclick="saveData()">üíæ ENREGISTRER DANS LA BASE</button>
                </div>
            </form>
        </div>
    </div>

    <div id="tab-matrice" class="page">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0">Matrice de codification (N=<span id="total-count">0</span>)</h3>
                <button class="btn-main" style="padding:10px 20px; font-size:13px; background:#2ecc71;" onclick="exportCSV()">üì• EXPORT CSV (EXCEL)</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>ID Dossier</th>
                            <th>√Çge</th>
                            <th>Sexe</th>
                            <th>Indication (Code)</th>
                            <th>Dent</th>
                            <th>Type Acte</th>
                            <th>Complication</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-analyse" class="page">
        <div class="stat-grid">
            <div class="stat-box">
                <div class="stat-number" id="stat-n">0</div>
                <div class="stat-label">Extractions totales</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="stat-carie">0%</div>
                <div class="stat-label">Pr√©valence Caries</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="stat-comp">0%</div>
                <div class="stat-label">Taux Complications</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="stat-sexe">0</div>
                <div class="stat-label">Ratio Homme/Femme</div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <h4>Distribution des Indications</h4>
                <div class="chart-container" id="chart-indications">
                    </div>
            </div>
            <div class="card">
                <h4>Types d'Extractions</h4>
                <div class="chart-container" id="chart-types">
                    </div>
            </div>
        </div>
    </div>

    <div id="tab-rapport" class="page">
        <div class="card">
            <h3>Synth√®se & Recommandations</h3>
            <div id="report-content" style="line-height:1.6;">
                <p>Veuillez entrer des donn√©es pour g√©n√©rer le rapport automatique.</p>
            </div>
        </div>
    </div>

</div>

<script>
    // --- INITIALISATION DES DONN√âES ---
    let db = JSON.parse(localStorage.getItem('dentalDB')) || [];
    let selectedTooth = null;

    // --- LOGIQUE UI ---
    function openTab(evt, tabName) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
        if(tabName === 'tab-analyse') updateCharts();
        if(tabName === 'tab-rapport') generateReport();
    }

    // G√©n√©rateur de grille dentaire ISO
    const selector = document.getElementById('tooth-selector');
    const teeth = [18,17,16,15,14,13,12,11, 21,22,23,24,25,26,27,28, 48,47,46,45,44,43,42,41, 31,32,33,34,35,36,37,38];
    
    teeth.forEach(t => {
        const btn = document.createElement('div');
        btn.className = 'tooth-btn';
        btn.innerText = t;
        btn.onclick = () => {
            document.querySelectorAll('.tooth-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedTooth = t;
        };
        selector.appendChild(btn);
    });

    // --- FONCTIONS DATA ---
    function saveData() {
        const formData = {
            id: document.getElementById('id_dossier').value,
            date: document.getElementById('date_consultation').value,
            age: parseInt(document.getElementById('age').value),
            sexe: document.getElementById('sexe').value,
            prof: document.getElementById('profession').value,
            dent: selectedTooth,
            indication: document.getElementById('indication').value,
            type: document.getElementById('type_ext').value,
            comp: document.getElementById('complication').value,
            radio: document.querySelector('input[name="radio_bool"]:checked').value
        };

        if(!formData.id || !formData.dent) {
            alert("Veuillez remplir au moins l'ID du dossier et choisir une dent.");
            return;
        }

        db.push(formData);
        localStorage.setItem('dentalDB', JSON.stringify(db));
        updateTable();
        alert("Donn√©es enregistr√©es avec succ√®s !");
        document.getElementById('extractionForm').reset();
        document.querySelectorAll('.tooth-btn').forEach(b => b.classList.remove('selected'));
    }

    function updateTable() {
        const tbody = document.getElementById('table-body');
        document.getElementById('total-count').innerText = db.length;
        tbody.innerHTML = db.map(row => `
            <tr>
                <td><b>${row.id}</b></td>
                <td>${row.age} ans</td>
                <td>${row.sexe == 1 ? 'M' : 'F'}</td>
                <td><span class="badge badge-blue">Indic. ${row.indication}</span></td>
                <td>Tooth #${row.dent}</td>
                <td>${row.type == 1 ? 'Simple' : 'Chirurgicale'}</td>
                <td style="color:${row.comp != 0 ? '#e67e22' : '#27ae60'}">${row.comp != 0 ? 'Oui (Code '+row.comp+')' : 'N√©ant'}</td>
            </tr>
        `).join('');
    }

    function updateCharts() {
        const n = db.length;
        if(n === 0) return;

        document.getElementById('stat-n').innerText = n;
        
        // Calcul pr√©valence carie (Code 1)
        const caries = db.filter(r => r.indication == 1).length;
        document.getElementById('stat-carie').innerText = Math.round((caries/n)*100) + "%";

        // Complications
        const comps = db.filter(r => r.comp != 0).length;
        document.getElementById('stat-comp').innerText = Math.round((comps/n)*100) + "%";

        // Graphique Indications
        const indicLabels = ["Carie", "Pulpo-P√©ri", "Parodont.", "Incluses", "Trauma", "Ortho", "Autres"];
        const indicData = [1,2,3,4,5,6,7].map(code => db.filter(r => r.indication == code).length);
        const maxVal = Math.max(...indicData, 1);

        document.getElementById('chart-indications').innerHTML = indicData.map((val, i) => `
            <div class="bar" style="height: ${(val/maxVal)*100}%">
                <div class="bar-label">${val}</div>
                <div class="bar-name">${indicLabels[i]}</div>
            </div>
        `).join('');
    }

    function generateReport() {
        if(db.length === 0) return;
        const mainCause = [1,2,3,4,5,6,7].map(c => ({c, count: db.filter(r => r.indication == c).length}))
                            .sort((a,b) => b.count - a.count)[0];
        
        const causes = ["Carie", "Complication pulpaire", "Parodontopathie", "Dents incluses", "Traumatisme", "Orthodontie", "Autres"];

        document.getElementById('report-content').innerHTML = `
            <div style="background:#f9fafb; padding:20px; border-radius:10px; border-left:4px solid #0277bd;">
                <p><strong>Conclusion Statistique :</strong> Sur un √©chantillon de ${db.length} extractions, la cause pr√©dominante √† l'HGR Makala est <strong>${causes[mainCause.c - 1]}</strong> (${mainCause.count} cas).</p>
                <p><strong>Recommandation 1 :</strong> Renforcer la pr√©vention primaire de la carie dentaire par des campagnes de sensibilisation au sein de la zone de sant√© de Makala.</p>
                <p><strong>Recommandation 2 :</strong> Am√©liorer le plateau technique pour la prise en charge des complications (actuellement ${Math.round((db.filter(r=>r.comp!=0).length/db.length)*100)}% des cas).</p>
            </div>
        `;
    }

    function exportCSV() {
        let csv = "ID;Age;Sexe;Indication;Dent;Type;Complication;Radio\n";
        db.forEach(r => {
            csv += `${r.id};${r.age};${r.sexe};${r.indication};${r.dent};${r.type};${r.comp};${r.radio}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', 'donnees_makala_extraction.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Init au chargement
    updateTable();
</script>

</body>
</html>
